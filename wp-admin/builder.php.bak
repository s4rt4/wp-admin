<?php
require_once 'db_config.php';

$pageId = isset($_GET['id']) ? intval($_GET['id']) : 0;
$pageData = null;

if ($pageId > 0) {
    $pdo = getDBConnection();
    $stmt = $pdo->prepare("SELECT * FROM pages WHERE id = ?");
    $stmt->execute([$pageId]);
    $pageData = $stmt->fetch();
    
    if (!$pageData) {
        die("Page not found");
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $pageData ? 'Edit: ' . htmlspecialchars($pageData['title']) : 'Page Builder'; ?></title>
    
    <!-- GrapesJS CSS -->
    <link rel="stylesheet" href="assets/js/grapesjs/grapes.min.css">
    
    <style>
        /* WP Admin Generic Reset */
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; background: #f0f0f1; margin: 0; }
        
        /* Modal Styles matching Media Library */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }
        
        .modal {
            background: #fff; 
            width: 500px; max-width: 90vw;
            border-radius: 0; 
            box-shadow: 0 5px 40px rgba(0,0,0,0.4);
            max-height: 90vh; 
            display: flex; flex-direction: column;
            padding: 0; 
            position: relative;
        }

        .modal-header {
            padding: 12px 20px; 
            border-bottom: 1px solid #ddd; 
            background: #f6f7f7;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .modal-header h2 {
            margin: 0; 
            font-size: 18px; 
            font-weight: 600; 
            color: #1d2327;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
        }
        
        /* Form Styles */
        .form-group { margin-bottom: 20px; }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
            color: #1d2327;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0 8px;
            line-height: 2;
            min-height: 30px;
            border: 1px solid #8c8f94;
            border-radius: 4px;
            font-size: 14px;
            color: #2c3338;
            box-shadow: 0 0 0 transparent;
            transition: box-shadow .1s linear;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2271b1;
            box-shadow: 0 0 0 1px #2271b1;
        }
        
        .form-group inputÂ∞èsmall {
             font-style: italic; color: #646970; margin-top: 4px; display: block; font-size: 12px;
        }

        /* Builder Selection Cards */
        .builder-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .builder-option {
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            padding: 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: #fff;
        }
        
        .builder-option:hover {
            border-color: #2271b1;
            background: #f0f6fc;
        }
        
        .builder-option.selected {
            border-color: #2271b1;
            background: #f0f6fc;
            box-shadow: 0 0 0 1px #2271b1;
            position: relative;
        }
        
        .builder-option h3 {
            margin: 0 0 8px;
            color: #1d2327;
            font-size: 14px;
        }
        
        .builder-option p {
            font-size: 12px;
            color: #646970;
            margin: 0;
        }
        
        /* Buttons */
        .btn {
            display: inline-block;
            text-decoration: none;
            font-size: 13px;
            line-height: 2.15384615;
            min-height: 30px;
            padding: 0 10px;
            cursor: pointer;
            border-width: 1px;
            border-style: solid;
            -webkit-appearance: none;
            border-radius: 3px;
            white-space: nowrap;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #2271b1;
            border-color: #2271b1;
            color: #fff;
            width: 100%;
            text-align: center;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: #135e96;
            border-color: #135e96;
            color: #fff;
        }
        
        .btn-primary:active {
            background: #135e96;
            border-color: #135e96;
            transform: translateY(1px);
        }
        
        .error-message {
            color: #d63638;
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Builder Container */
        #builder-container {
            display: none;
        }
        
        /* GrapesJS Styles */
        #grapesjs-editor {
            height: 100vh;
        }
        
        /* EditorJS Styles */
        #editorjs-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f0f0f1;
            overflow: hidden;
        }
        
        #editorjs-toolbar {
            background: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid #c3c4c7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        #editorjs-toolbar .left {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        #editorjs-toolbar .center {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        #editorjs-toolbar .right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #editorjs-toolbar h2 {
            margin: 0;
            font-size: 16px;
            color: #1d2327;
            font-weight: 600;
        }
        
        /* Toolbar Icon Buttons */
        .toolbar-btn {
            background: transparent;
            border: none;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 3px;
            color: #50575e;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 13px;
            line-height: 1;
        }
        
        .toolbar-btn:hover {
            background: #f0f0f1;
            color: #2271b1;
        }
        
        .toolbar-btn.active {
            background: #2271b1;
            color: #fff;
        }
        
        .toolbar-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        /* Device Buttons Group */
        .device-buttons {
            display: flex;
            gap: 2px;
            background: #f0f0f1;
            padding: 3px;
            border-radius: 4px;
        }
        
        /* EditorJS Content Wrapper */
        #editorjs-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            justify-content: center;
            transition: all 0.3s ease;
            background: #f0f0f1;
        }
        
        #editorjs-content {
            width: 100%;
            max-width: 900px;
            background: #fff;
            padding: 40px;
            border: 1px solid #c3c4c7;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            min-height: calc(100vh - 100px);
            box-sizing: border-box;
        }
        
        /* Device Preview Modes */
        #editorjs-wrapper.device-mobile #editorjs-content {
            max-width: 375px;
        }
        
        #editorjs-wrapper.device-tablet #editorjs-content {
            max-width: 768px;
        }
        
        #editorjs-wrapper.device-desktop #editorjs-content {
            max-width: 1200px;
        }
        
        #editorjs {
            background: transparent;
            min-height: 500px;
            padding: 0;
            border: none;
        }
        
        /* Dark Mode for EditorJS */
        /* IMPORTANT: Body tetap normal, hanya container yang berubah */
        body.dark-mode-editorjs #editorjs-container {
            background: #1d2327;
        }
        
        body.dark-mode-editorjs #editorjs-toolbar {
            background: #2c3338;
            border-bottom-color: #50575e;
        }
        
        body.dark-mode-editorjs #editorjs-toolbar h2 {
            color: #f0f0f1;
        }
        
        /* IMPORTANT: Canvas tetap putih dengan teks hitam */
        body.dark-mode-editorjs #editorjs-content {
            background: #fff;
            border-color: #50575e;
            color: #1d2327;
        }
        
        /* IMPORTANT: EditorJS editor area tetap default (putih) */
        body.dark-mode-editorjs #editorjs {
            background: #fff;
            color: #1d2327;
        }
        
        /* EditorJS toolbar dan UI elements tetap default */
        body.dark-mode-editorjs .ce-toolbar,
        body.dark-mode-editorjs .ce-block,
        body.dark-mode-editorjs .ce-block__content {
            background: transparent;
            color: #1d2327;
        }
        
        body.dark-mode-editorjs .toolbar-btn {
            color: #a7aaad;
        }
        
        body.dark-mode-editorjs .toolbar-btn:hover {
            background: #1d2327;
            color: #fff;
        }
        
        body.dark-mode-editorjs .toolbar-btn.active {
            background: #2271b1;
            color: #fff;
        }
        
        body.dark-mode-editorjs .device-buttons {
            background: #1d2327;
        }
        
        body.dark-mode-editorjs #editorjs-wrapper {
            background: #1d2327;
        }
        
        body.dark-mode-editorjs #status-select {
            background: #2c3338;
            color: #f0f0f1;
            border-color: #50575e;
        }
        
        /* Toast Notification Styles */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            z-index: 10000;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out forwards;
        }
        
        .toast-notification.success { background: #46b450; }
        .toast-notification.error { background: #dc3232; }
        .toast-notification.info { background: #2271b1; }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        
        #editorjs-toolbar .left {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #editorjs-toolbar h2 {
            margin: 0;
            font-size: 16px;
            color: #1d2327;
        }
        
        #editorjs {
            background: #fff;
            min-height: 500px;
            padding: 20px;
            border: 1px solid #c3c4c7;
        }
    </style>
</head>
<body>
    <?php if (!$pageData): ?>
    <!-- Create New Page Modal -->
    <div class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Create New Page</h2>
            </div>
            <div class="modal-body">
                <form id="create-page-form">
                    <div class="form-group">
                        <label for="page-title">Page Title *</label>
                        <input type="text" id="page-title" name="title" required placeholder="Enter page title" autofocus>
                    </div>
                    
                    <div class="form-group">
                        <label for="page-slug">Slug *</label>
                        <input type="text" id="page-slug" name="slug" required placeholder="page-url-slug">
                        <small style="font-style: italic; color: #646970; margin-top: 4px; display: block; font-size: 12px;">Used in the URL (e.g., yourdomain.com/slug). Use lowercase letters, numbers, and hyphens only.</small>
                        <span id="slugError" class="error-message"></span>
                    </div>
                    
                    <div class="form-group">
                        <label>Choose Page Builder *</label>
                        <div class="builder-options">
                            <div class="builder-option selected" data-builder="grapesjs">
                                <h3>GrapesJS</h3>
                                <p>Visual drag & drop builder</p>
                            </div>
                            <div class="builder-option" data-builder="editorjs">
                                <h3>EditorJS</h3>
                                <p>Block-based content editor</p>
                            </div>
                        </div>
                        <input type="hidden" id="builder-type" name="builder_type" value="grapesjs">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Create Page</button>
                </form>
            </div>
        </div>
    </div>
    <?php endif; ?>
    
    <!-- Builder Container (shown after page is created or when editing) -->
    <div id="builder-container">
        <?php if ($pageData && $pageData['builder_type'] === 'grapesjs'): ?>
            <div id="grapesjs-editor"></div>
        <?php elseif ($pageData && $pageData['builder_type'] === 'editorjs'): ?>
            <div id="editorjs-container">
                <div id="editorjs-toolbar">
                    <div class="left">
                        <button id="back-dashboard-btn" class="toolbar-btn" title="Back to Dashboard">
                            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
                        </button>
                        <h2><?php echo htmlspecialchars($pageData['title']); ?></h2>
                    </div>
                    <div class="center">
                        <div class="device-buttons">
                            <button class="toolbar-btn device-btn active" data-device="desktop" title="Desktop View">
                                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21,16H3V4H21M21,2H3C1.89,2 1,2.89 1,4V16A2,2 0 0,0 3,18H10V20H8V22H16V20H14V18H21A2,2 0 0,0 23,16V4C23,2.89 22.1,2 21,2Z" /></svg>
                            </button>
                            <button class="toolbar-btn device-btn" data-device="tablet" title="Tablet View">
                                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,18H5V6H19M21,4H3C1.89,4 1,4.89 1,6V18A2,2 0 0,0 3,20H21A2,2 0 0,0 23,18V6C23,4.89 22.1,4 21,4Z" /></svg>
                            </button>
                            <button class="toolbar-btn device-btn" data-device="mobile" title="Mobile View">
                                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M17,19H7V5H17M17,1H7C5.89,1 5,1.89 5,3V21A2,2 0 0,0 7,23H17A2,2 0 0,0 19,21V3C19,1.89 18.1,1 17,1Z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="right">
                        <button id="theme-toggle-btn" class="toolbar-btn" title="Toggle Dark Mode">
                            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.12L13.75,3.24L12.38,4.3L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.35L10.24,7.44L9.15,8.27L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.96L14.24,13.96C15.55,13.37 16.9,13.15 18.39,13.28L19,13.5Z" /></svg>
                        </button>
                        <select id="status-select" style="padding: 6px 10px; border: 1px solid #8c8f94; border-radius: 3px; font-size: 13px;">
                            <option value="draft" <?php echo $pageData['status'] === 'draft' ? 'selected' : ''; ?>>Draft</option>
                            <option value="publish" <?php echo $pageData['status'] === 'publish' ? 'selected' : ''; ?>>Published</option>
                        </select>
                        <button id="save-btn" class="btn btn-primary" style="width: auto;">Save</button>
                    </div>
                </div>
                <div id="editorjs-wrapper" class="device-desktop">
                    <div id="editorjs-content">
                        <div id="editorjs"></div>
                    </div>
                </div>
            </div>
        <?php endif; ?>
    </div>
    
    <!-- GrapesJS Scripts -->
    <script src="assets/js/grapesjs/grapes.min.js"></script>
    
    <!-- GrapesJS Plugins (Local) -->
    <script src="assets/js/grapesjs/grapesjs-preset-webpage.min.js"></script>
    <script src="assets/js/grapesjs/grapesjs-blocks-basic.min.js"></script>
    <script src="assets/js/grapesjs/grapesjs-plugin-forms.min.js"></script>
    
    <!-- GrapesJS Plugins (CDN) -->
    <script src="https://unpkg.com/grapesjs-plugin-export"></script>
    <script src="https://unpkg.com/grapesjs-navbar"></script>
    <script src="https://unpkg.com/grapesjs-component-countdown"></script>
    <script src="https://unpkg.com/grapesjs-style-gradient"></script>
    <script src="https://unpkg.com/grapesjs-style-filter"></script>
    <script src="https://unpkg.com/grapesjs-style-bg"></script>
    <script src="https://unpkg.com/grapesjs-tabs"></script>
    <script src="https://unpkg.com/grapesjs-tooltip"></script>
    <script src="https://unpkg.com/grapesjs-custom-code"></script>
    <script src="https://unpkg.com/grapesjs-typed"></script>
    
    <!-- EditorJS Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@latest"></script>
    
    <script>
        const pageData = <?php echo $pageData ? json_encode($pageData) : 'null'; ?>;
        let grapesEditor;
        let editorJSInstance;
        let currentEditor;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Builder option selection
            document.querySelectorAll('.builder-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.builder-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('builder-type').value = this.dataset.builder;
                });
            });
            
            // Auto-generate slug from title
            const titleInput = document.getElementById('page-title');
            const slugInput = document.getElementById('page-slug');
            
            if (titleInput && slugInput) {
                titleInput.addEventListener('input', function() {
                    const slug = this.value
                        .toLowerCase()
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');
                    slugInput.value = slug;
                    document.getElementById('slugError').textContent = '';
                });
            }
            
            // Create page form submission
            const createForm = document.getElementById('create-page-form');
            if (createForm) {
                createForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        title: document.getElementById('page-title').value,
                        slug: document.getElementById('page-slug').value,
                        builder_type: document.getElementById('builder-type').value,
                        status: 'draft'
                    };
                    
                    fetch('api.php?action=create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    })
                    .then(response => response.text())
                    .then(text => {
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error('Invalid JSON response:', text);
                            throw new Error('Server returned invalid JSON. Check your database configuration.');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            window.location.href = data.redirect;
                        } else {
                            if (data.error && data.error.includes('slug')) {
                                document.getElementById('slugError').textContent = data.error;
                            } else {
                                alert('Error: ' + (data.error || 'Unknown error'));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(error.message || 'An error occurred. Please try again.');
                    });
                });
            }
            
            // Initialize builder if page data exists
            if (pageData) {
                initializeBuilder(pageData.builder_type);
            }
        });
        
        function initializeBuilder(builderType) {
            document.getElementById('builder-container').style.display = 'block';
            
            if (builderType === 'grapesjs') {
                initGrapesJS();
            } else if (builderType === 'editorjs') {
                initEditorJS();
            }
        }
        
        function initGrapesJS() {
            // Initialize GrapesJS with CORRECTED storage configuration
            grapesEditor = grapesjs.init({
                container: '#grapesjs-editor',
                height: '100vh',
                width: 'auto',
                
                // Storage configuration - FIXED VERSION
                storageManager: {
                    type: 'remote',
                    autosave: true,
                    autoload: true,
                    stepsBeforeSave: 3,
                    
                    // Custom storage endpoints
                    options: {
                        remote: {
                            urlLoad: 'api.php?action=load&id=' + pageData.id,
                            urlStore: 'api.php?action=save',
                            
                            // REMOVED: fetchOptions that was forcing GET method
                            // This was causing the error: "GET Request cannot have a body"
                            
                            // Add proper headers for POST requests
                            fetchOptions: (opts) => {
                                // Only set method to POST for store operations
                                // GrapesJS will handle load as GET automatically
                                if (opts.method === 'POST') {
                                    opts.headers = {
                                        ...opts.headers,
                                        'Content-Type': 'application/json'
                                    };
                                }
                                return opts;
                            },
                            
                            // Custom fetch for storing
                            onStore: (data, editor) => {
                                const pagesHtml = editor.Pages.getAll().map(page => {
                                    return {
                                        html: editor.getHtml({ component: page.getMainComponent() }),
                                        css: editor.getCss({ component: page.getMainComponent() })
                                    };
                                });
                                
                                return {
                                    id: pageData.id,
                                    content: JSON.stringify({
                                        gjs: data,
                                        pages: pagesHtml
                                    })
                                };
                            },
                            
                            // Custom fetch for loading
                            onLoad: (result) => {
                                if (result && result.success && result.data && result.data.content && result.data.content.trim() !== '') {
                                    try {
                                        const parsed = JSON.parse(result.data.content);
                                        return parsed.gjs || {};
                                    } catch (e) {
                                        console.log('No existing content, starting fresh');
                                        return {};
                                    }
                                }
                                return {};
                            }
                        }
                    }
                },
                
                plugins: [
                    'grapesjs-preset-webpage', 
                    'gjs-blocks-basic', 
                    'grapesjs-plugin-forms',
                    'grapesjs-plugin-export',
                    'grapesjs-navbar',
                    'grapesjs-component-countdown',
                    'grapesjs-style-gradient',
                    'grapesjs-style-filter',
                    'grapesjs-style-bg',
                    'grapesjs-tabs',
                    'grapesjs-tooltip',
                    'grapesjs-custom-code',
                    'grapesjs-typed'
                ],
                pluginsOpts: {
                    'grapesjs-preset-webpage': {
                        blocksBasicOpts: {
                            blocks: ['column1', 'column2', 'column3', 'column3-7', 'text', 'link', 'image', 'video'],
                            flexGrid: 1,
                        },
                        blocks: ['link-block', 'quote', 'text-basic'],
                    }
                },
                
                canvas: {
                    styles: [],
                    scripts: [],
                },
                
                // Asset Manager - upload to media folder
                assetManager: {
                    upload: 'upload.php?source=grapesjs',
                    uploadName: 'files',
                    multiUpload: false,
                    autoAdd: true
                }
            });
            
            // Add custom blocks
            grapesEditor.BlockManager.add('card-block', {
                label: 'Card',
                media: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M20,2H4C2.9,2 2,2.9 2,4V20C2,21.1 2.9,22 4,22H20C21.1,22 22,21.1 22,20V4C22,2.9 21.1,2 20,2M20,20H4V13H20V20M20,11H4V4H20V11Z" /></svg>',
                category: 'Basic',
                content: {
                    type: 'div',
                    classes: ['card'],
                    style: {
                        'background-color': '#fff',
                        'border': '1px solid #e2e8f0',
                        'border-radius': '0.375rem',
                        'overflow': 'hidden',
                        'box-shadow': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'max-width': '300px',
                        'margin': '1rem'
                    },
                    components: [
                        {
                            tagName: 'img',
                            type: 'image',
                            attributes: { src: 'https://via.placeholder.com/350x200' },
                            style: { 'width': '100%', 'height': 'auto', 'display': 'block' }
                        },
                        {
                            tagName: 'div',
                            classes: ['card-body'],
                            style: { 'padding': '1.25rem' },
                            components: [
                                {
                                    tagName: 'h3',
                                    content: 'Card Title',
                                    style: { 'margin-top': '0', 'margin-bottom': '0.5rem', 'font-size': '1.25rem', 'font-weight': '600' }
                                },
                                {
                                    tagName: 'p',
                                    content: 'Some quick example text to build on the card title and make up the bulk of the card\'s content.',
                                    style: { 'margin-bottom': '1.25rem', 'color': '#4a5568' }
                                },
                                {
                                    tagName: 'a',
                                    content: 'Read More',
                                    attributes: { href: '#' },
                                    style: {
                                        'display': 'inline-block',
                                        'padding': '0.5rem 1rem',
                                        'background-color': '#4299e1',
                                        'color': 'white',
                                        'text-decoration': 'none',
                                        'border-radius': '0.25rem',
                                        'font-size': '0.875rem'
                                    }
                                }
                            ]
                        }
                    ]
                }
            });

            grapesEditor.BlockManager.add('hero-section', {
                label: 'Hero Section',
                media: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M2,2H22V22H2V2M4,4V20H20V4H4M6,6H18V10H6V6M6,12H18V14H6V12M6,16H18V18H6V16Z" /></svg>',
                category: 'Basic',
                content: `
                    <section class="hero-section" style="padding: 4rem 2rem; text-align: center; background-color: #f7fafc; border-bottom: 1px solid #e2e8f0;">
                        <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: #2d3748;">Welcome to My Website</h1>
                        <p style="font-size: 1.25rem; margin-bottom: 2rem; color: #718096; max-width: 600px; margin-left: auto; margin-right: auto;">This is a simple hero unit, a simple jumbotron-style component for calling extra attention to featured content or information.</p>
                        <a href="#" style="background-color: #4299e1; color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 0.25rem; font-size: 1rem; font-weight: 600;">Learn More</a>
                    </section>
                `
            });
            
            // Load existing media files from server
            fetch('api.php?action=media')
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const am = grapesEditor.AssetManager;
                        result.data.forEach(asset => {
                            am.add(asset);
                        });
                        console.log(`Loaded ${result.data.length} media files from library`);
                    }
                })
                .catch(err => console.error('Error loading media library:', err));
            
            // Refresh media files every time asset manager is opened
            grapesEditor.on('asset:open', () => {
                fetch('api.php?action=media')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success && result.data) {
                            const am = grapesEditor.AssetManager;
                            // Get existing asset sources to avoid duplicates
                            const existingAssets = am.getAll().map(a => a.get('src'));
                            
                            // Add only new assets
                            result.data.forEach(asset => {
                                if (!existingAssets.includes(asset.src)) {
                                    am.add(asset);
                                }
                            });
                        }
                    })
                    .catch(err => console.error('Error refreshing media library:', err));
            });
            
            // --- Custom UI & Theme Logic ---
            
            // Add custom styles for WP Theme (Light Mode Default)
            const customStyle = `
                :root {
                    --gjs-main-color: #2c3338;
                    --gjs-primary-color: #2271b1;
                    --gjs-secondary-color: #f0f0f1;
                    --gjs-font-color: #1d2327;
                    --gjs-font-color-active: #2271b1;
                }
                
                /* Light Mode Overrides (default for WP admin feel) */
                .gjs-one-bg { background-color: #ffffff; }
                .gjs-two-bg { background-color: #f0f0f1; }
                .gjs-three-bg { background-color: #2271b1; color: white; }
                .gjs-four-bg { background-color: #2c3338; }
                
                .gjs-one-color { color: #1d2327; }
                .gjs-two-color { color: #2c3338; }
                .gjs-three-color { color: white; }
                .gjs-four-color { color: #2271b1; }
                
                .gjs-pn-panel { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                .gjs-pn-btn { color: #50575e; }
                .gjs-pn-btn:hover { color: #2271b1; background: #f0f0f1; }
                .gjs-pn-btn.gjs-pn-active { color: #2271b1; background: #f0f0f1; box-shadow: none; border-bottom: 2px solid #2271b1; }
                
                /* Dark Mode Styling */
                body.dark-mode .gjs-one-bg { background-color: #1d2327; }
                body.dark-mode .gjs-two-bg { background-color: #2c3338; }
                body.dark-mode .gjs-three-bg { background-color: #2271b1; }
                body.dark-mode .gjs-four-bg { background-color: #101517; }
                
                body.dark-mode .gjs-one-color { color: #dcdcde; }
                body.dark-mode .gjs-two-color { color: #f0f0f1; }
                body.dark-mode .gjs-pn-btn { color: #a7aaad; }
                body.dark-mode .gjs-pn-btn:hover { color: white; background: #2c3338; }
                body.dark-mode .gjs-pn-btn.gjs-pn-active { color: white; background: #2c3338; border-bottom-color: #2271b1; }

                /* Override Pink Colors to #4173A6 */
                .gjs-block__media { color: #4173A6; }
                .fa-cog, .fa-paint-brush, .fa-desktop, .fa-tablet, .fa-mobile { color: #4173A6; }
                
                /* Additional clean overrides */
                .gjs-clm-tags .gjs-clm-tag { background: #f0f0f1; color: #1d2327; border: 1px solid #c3c4c7; }
                .gjs-sm-property .gjs-sm-btn { background: #2271b1; color: white; }
                .gjs-am-assets { background: #fff; }
            `;
            
            const styleEl = document.createElement('style');
            styleEl.textContent = customStyle;
            document.head.appendChild(styleEl);
            
            // Listen to storage events for feedback
            grapesEditor.on('storage:start', () => {
                showToast('Saving...', 'info');
            });
            
            grapesEditor.on('storage:end', () => {
                showToast('Page saved successfully!', 'success');
            });
            
            grapesEditor.on('storage:error', (err) => {
                console.error('Save error:', err);
                showToast('Save failed: ' + err, 'error');
            });
            
            const panels = grapesEditor.Panels;
            
            // Back to Dashboard Button
            panels.addButton('options', [{
                id: 'back-to-dashboard',
                command: 'back-to-dashboard',
                attributes: { title: 'Back to Dashboard' },
                label: '<svg viewBox="0 0 24 24" style="height:22px; display:block"><path fill="currentColor" d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>'
            }]);
            
            grapesEditor.Commands.add('back-to-dashboard', {
                run: function(editor) {
                    // Try to save before leaving
                    showToast('Saving and exiting...', 'info');
                    editor.store();
                    
                    // Give it a brief moment to ensure save request is sent
                    setTimeout(() => {
                        window.location.href = 'pages.php';
                    }, 800);
                }
            });


            // Theme Toggle Button
            panels.addButton('options', [{
                id: 'theme-toggle',
                command: 'toggle-theme',
                attributes: { title: 'Toggle Dark/Light Mode' },
                label: '<svg viewBox="0 0 24 24" style="height:22px; display:block"><path fill="currentColor" d="M7.5,2C5.71,3.15 4.5,5.18 4.5,7.5C4.5,9.82 5.71,11.85 7.53,13C4.46,13 2,10.54 2,7.5A5.5,5.5 0 0,1 7.5,2M19.07,3.5L20.5,4.93L4.93,20.5L3.5,19.07L19.07,3.5M12.89,5.93L11.41,5L9.97,6L10.39,4.3L9,3.24L10.75,3.12L11.33,1.47L12,3.12L13.75,3.24L12.38,4.3L12.89,5.93M9.59,9.54L8.43,8.81L7.31,9.59L7.65,8.27L6.56,7.44L7.92,7.35L8.37,6.06L8.88,7.35L10.24,7.44L9.15,8.27L9.59,9.54M19,13.5A5.5,5.5 0 0,1 13.5,19C12.28,19 11.15,18.6 10.24,17.96L14.24,13.96C15.55,13.37 16.9,13.15 18.39,13.28L19,13.5Z" /></svg>'
            }]);
            
            let isDarkMode = false;
            grapesEditor.Commands.add('toggle-theme', {
                run: function() {
                    isDarkMode = !isDarkMode;
                    if (isDarkMode) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                }
            });

            console.log('GrapesJS initialized with fixed storage configuration.');
            console.log('Autosave is ENABLED (every 3 steps).');

            currentEditor = grapesEditor;
        }
        
        function initEditorJS() {
            // Resolve CDN global names (UMD bundles may expose different names)
            const EditorJSClass = window.EditorJS;
            const HeaderClass = window.Header;
            const ListClass = window.List || window.EditorjsList || window.NestedList;
            const CodeClass = window.CodeTool;
            const QuoteClass = window.Quote;
            const TableClass = window.Table;
            const SimpleImageClass = window.SimpleImage;
            const ImageToolClass = window.ImageTool;
            const RawClass = window.RawTool;
            
            if (!EditorJSClass) {
                console.error('EditorJS library not loaded!');
                document.getElementById('editorjs').innerHTML = '<p style="padding:40px;color:red;">Error: EditorJS library failed to load. Check your internet connection or console for errors.</p>';
                return;
            }
            
            // Parse existing content
            let initialData = {
                blocks: []
            };
            
            if (pageData && pageData.content) {
                try {
                    const content = JSON.parse(pageData.content);
                    if (content.editorjs) {
                        initialData = content.editorjs;
                    }
                } catch (e) {
                    console.log('Starting with fresh content');
                }
            }
            
            // Build tools config dynamically (only include loaded plugins)
            const tools = {};
            
            if (HeaderClass) {
                tools.header = {
                    class: HeaderClass,
                    inlineToolbar: true,
                    config: {
                        placeholder: 'Enter a header',
                        levels: [1, 2, 3, 4, 5, 6],
                        defaultLevel: 2
                    }
                };
            }
            
            if (ListClass) {
                tools.list = {
                    class: ListClass,
                    inlineToolbar: true,
                    config: {
                        defaultStyle: 'unordered'
                    }
                };
            }
            
            if (CodeClass) {
                tools.code = { class: CodeClass };
            }
            
            if (QuoteClass) {
                tools.quote = {
                    class: QuoteClass,
                    inlineToolbar: true,
                    config: {
                        quotePlaceholder: 'Enter a quote',
                        captionPlaceholder: 'Quote\'s author',
                    }
                };
            }
            
            if (TableClass) {
                tools.table = {
                    class: TableClass,
                    inlineToolbar: true,
                };
            }
            
            if (ImageToolClass) {
                tools.image = {
                    class: ImageToolClass,
                    config: {
                        endpoints: {
                            byFile: 'upload.php?source=editorjs',
                            byUrl: 'upload.php?source=editorjs'
                        },
                        field: 'image',
                        types: 'image/jpeg, image/png, image/gif, image/webp'
                    }
                };
            } else if (SimpleImageClass) {
                tools.image = SimpleImageClass;
            }
            
            if (RawClass) {
                tools.raw = {
                    class: RawClass,
                    inlineToolbar: true,
                };
            }
            
            // Initialize EditorJS
            editorJSInstance = new EditorJSClass({
                holder: 'editorjs',
                tools: tools,
                data: initialData,
                placeholder: 'Start writing your content here...',
                
                onReady: () => {
                    console.log('EditorJS is ready!');
                },
                
                onChange: () => {
                    console.log('Content changed');
                }
            });
            
            // Save button handler
            document.getElementById('save-btn').addEventListener('click', saveEditorJS);
            
            // Status change handler
            document.getElementById('status-select').addEventListener('change', function() {
                saveEditorJS();
            });
            
            // Back to Dashboard button
            document.getElementById('back-dashboard-btn').addEventListener('click', function() {
                showToast('Saving and returning to dashboard...', 'info');
                saveEditorJS().then(() => {
                    setTimeout(() => {
                        window.location.href = 'pages.php';
                    }, 800);
                });
            });
            
            // Device Preview buttons
            const deviceButtons = document.querySelectorAll('.device-btn');
            const editorWrapper = document.getElementById('editorjs-wrapper');
            
            deviceButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    deviceButtons.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Change device view
                    const device = this.dataset.device;
                    editorWrapper.className = `device-${device}`;
                    
                    showToast(`Switched to ${device} view`, 'info');
                });
            });
            
            // Dark Mode Toggle
            let isDarkModeEditorJS = false;
            document.getElementById('theme-toggle-btn').addEventListener('click', function() {
                isDarkModeEditorJS = !isDarkModeEditorJS;
                
                if (isDarkModeEditorJS) {
                    document.body.classList.add('dark-mode-editorjs');
                    showToast('Dark mode enabled', 'info');
                } else {
                    document.body.classList.remove('dark-mode-editorjs');
                    showToast('Light mode enabled', 'info');
                }
            });
            
            currentEditor = editorJSInstance;
        }
        
        async function saveEditorJS() {
            try {
                const outputData = await editorJSInstance.save();
                const status = document.getElementById('status-select').value;
                
                const response = await fetch('api.php?action=save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: pageData.id,
                        content: JSON.stringify({
                            editorjs: outputData
                        }),
                        status: status
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success feedback
                    const saveBtn = document.getElementById('save-btn');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = 'Saved!';
                    saveBtn.style.background = '#4CAF50';
                    
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.style.background = '';
                    }, 2000);
                } else {
                    alert('Error saving: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving:', error);
                alert('An error occurred while saving');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, 3000);
        }
    </script>
</body>
</html>